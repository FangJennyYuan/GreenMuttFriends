@using WebApplication1.Models;
@model List<TotalPhotosTakenModel>

<!doctype html>
<meta charset="utf-8">

<script src="//d3plus.org/js/d3.js"></script>
<script src="//d3plus.org/js/d3plus.js"></script>

@{
    ViewBag.Title = "Performance Dashboard";
}

<div>
    @*header*@
    <div class="row header-performance">
        <div class="col-lg-7">
            <h1>
                Performance Dashboard
            </h1>
        </div>

        <div class="col mr-4 align-self-end">
            <div class="row chart-filters ">
                @*Overview icon*@
                <div class="overviewcard col-lg-5 col-sm-4 ml-2 align-self-end active-charts" id="overview-charts">
                    <div class="overviewcard__icon">
                        <i class="fa fa-camera-retro  filter-performance-ic img-valign" aria-hidden="true"></i>
                        <span>Overview</span>
                    </div>
                </div>
                @*Userview icon*@
                <div class="overviewcard col-lg-5 col-sm-4 ml-2" id="device-charts">
                    <div class="overviewcard__icon">
                        <i class="fa fa-server  filter-performance-ic img-valign" aria-hidden="true"></i>
                        <span>User view</span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    @*Date filter row*@
    <div class="row date-filter mt-1">
        @*Calender icon*@
        <div class="overviewcard__icon ml-3">
            <i class="fa fa-calendar  filter-performance-ic img-valign" aria-hidden="true"></i>
        </div>
        @*Week filter*@
        <div class="col-lg-1 col-sm-3 mt-2 calendar-filter active-date-range">
            <button type="button" id="week" onclick="getWeeksDate()"> Week</button>
        </div>
        @*Month filter*@
        <div class="col-lg-1 col-sm-3 mr-2 mt-2 calendar-filter">
            <button type="button" id="month" onclick="getMonthsDate()"> Month</button>
        </div>
        @*All filter*@
        <div class="col-lg-1 col-sm-3 mt-2 calendar-filter">
            <button type="button" id="all-date" class="calendar-filter" onclick="getYearsDate()"> All</button>
        </div>
        @*Date filter*@
        <div class="col-lg-4 mt-2">
            Date
            <input type="text" id="date-input" name="daterange" value="" />
        </div>
    </div>
</div>

@*Graph section*@
<div class="row mt-3 performance-graphs white-background">
    @*Photo taken graph*@
    <div class="col-lg-7 ml-2">
        <div class="row ">
            @*Graph header that is changed based on date filter*@
            <div class="col">
                <h3> Photos Taken <span class="graph-filtered-by date"> from Month xxth to Month xxth </span></h3>
            </div>
            @*fav button*@
            <div class="col-1">
                @{var myAccountModel = WebApplication1.Backend.AccountBackend.Instance.GetActiveUser();
                    if (myAccountModel.isAccountLoggedIn)
                    {
                        <label for="id-of-input7" class="custom-checkbox favorite-graph">
                            <input type="checkbox" id="id-of-input7" class="favorites" />
                            <i class="fa fa-star fa-stack-1x favorited"></i>
                            <i class="fa fa-star-o fa-stack-1x not-favorited"></i>
                        </label>
                    }
                    else { }}
            </div>
        </div>
        @*photos taken graph*@
        <div id="photos_taken_chart"></div>
    </div>
    @*Avg Photo based on device*@
    <div class="col">
        <div class="row">
            @*Graph header that is changed based on date filter*@
            <div class="col">
                <h3> Avg Photos <span class="graph-filtered-by date"> from Month xxth to Month xxth </span></h3>
            </div>
            @*fav button*@
            <div class="col-1">
                @{
                    if (myAccountModel.isAccountLoggedIn)
                    {
                        <label for="id-of-input8" class="custom-checkbox favorite-graph" onload="load()">
                            <input type="checkbox" id="id-of-input8" class="favorites" onclick="save()" />
                            <i class="fa fa-star fa-stack-1x favorited"></i>
                            <i class="fa fa-star-o fa-stack-1x not-favorited"></i>
                        </label>
                    }
                    else
                    {

                    }
                }
            </div>
        </div>
        @*graph section*@
        <div id="avg_photos_taken_chart"></div>
    </div>
</div>



<script>
    //load the fav checkbox id-of-input8 with what is stored in localstorage
    window.onload = function load() {
        var checked = JSON.parse(localStorage.getItem('id-of-input8'));
        console.log(checked);
        document.getElementById("id-of-input8").checked = checked;
    }

    //save the fav checkbox id-of-input8 state into localstorage
    function save() {
        var checkbox = document.getElementById('id-of-input8');
        console.log(checkbox.checked);
        localStorage.setItem('id-of-input8', checkbox.checked);
    }

    //Pull Photos Data on Week
    $("#week").click(
        function () {
            start = moment().subtract(7, 'days');
            end = moment();
            drawPhotosTakenViz(start, end);
            applyButtonStyleDates(this);
        }
    );

    //Pull Photos Data on Month
    $("#month").click(
        function () {
            start = moment().startOf('month');
            end = moment();
            drawPhotosTakenViz(start, end);
            applyButtonStyleDates(this);
        }
    );

    //Pull Photos Data on Month
    $("#all-date").click(
        function () {
            start = moment("4/1/2019");
            end = moment();
            drawPhotosTakenViz(start, end);
            applyButtonStyleDates(this);
        }
    );

    //Select a chart series
    $(".overviewcard").click(function () {
        //remove all other selected
        $(".overviewcard").removeClass("active-charts");
        $(this).toggleClass("active-charts");
    });

    //Draw overview graphs on performance page
    function drawPhotosTakenViz(start, end) {
        //Get data
        currentPhotoData = getDatabyDate( start, end );
        updateGraphTitlesWithDate(start, end );

        //Remove old graph and add new
        $("#photos_taken_chart").empty();
        drawPhotosTakenGraph(currentPhotoData);

        //Remove old graph and add new
        $("#avg_photos_taken_chart").empty();
        drawAvgPhotosTakenGraph(currentPhotoData, start, end);
    }

    //Get data by date
    function getDatabyDate(start, end) {
            photosData = [
            @{
                foreach (var item in Model)
                {
                    var photosTakenAmp = 0;
                    //TODO: Remove in production, Just amplifying Ijora Clinic Results For Demo
                    if(item.Clinic == "Ijora Clinic")
                    {
                        photosTakenAmp = Convert.ToInt32(item.Value * 2.3);
                    }
                    else{
                        photosTakenAmp = item.Value;
                    }

                    var outputString = Html.Raw("{ clinic: \"" + item.Clinic + "\", date: \"" + item.Date.ToShortDateString() + "\", value: " + photosTakenAmp + ", userCount: " + item.UserCount + " },");
                    @outputString
                }
            }
            ],
            start = start,
            end = end,
            currentPhotoData = photosData.filter(d => {
                var date = new moment(d.date);
                return (start <= date && date <= end);
            });
        return currentPhotoData;
    };


    //Default views
    $("#overview-charts").trigger("click");
    $('#week').click(drawPhotosTakenViz(moment().subtract(7, 'days'), moment()));
</script>
